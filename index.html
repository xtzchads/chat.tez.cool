<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Chad Chat: A secure and user-friendly chat application. Connect your wallet, chat with friends, or troll anons - do whatever you like">
  <title>Chad Chat</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <script src="js/walletbeacon.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap" rel="stylesheet">
  <style>
    @import url("https://fonts.googleapis.com/css?family=Monda:400,500,600");

    /* CSS Variables */
    :root {
      --colorful: rgba(239, 123, 227, 1);
      --primary-gradient: linear-gradient(180deg, rgba(162, 124, 238, 1) 0%, rgba(127, 75, 231, 1) 100%);
      --glass-bg: rgba(255, 255, 255, 0.01);
      --glass-border: rgba(255, 255, 255, 0.26);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.5);
      --shadow-glass: 11px 14px 39px rgba(5, 2, 13, 0.1), 45px 54px 70px rgba(5, 2, 13, 0.09), 100px 122px 95px rgba(5, 2, 13, 0.05);
      --border-radius-sm: 16px;
      --border-radius-md: 30px;
      --spacing-xs: 8px;
      --spacing-sm: 16px;
      --spacing-md: 24px;
      --spacing-lg: 32px;
      --spacing-xl: 48px;
      --my-message-bg: linear-gradient(135deg, rgba(162, 124, 238, 0.2) 0%, rgba(127, 75, 231, 0.2) 100%);
      --other-message-bg: rgba(255, 255, 255, 0.05);
      --hover-color: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(255, 255, 255, 0.05);
    }

    /* Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Monda", Helvetica;
      -webkit-font-smoothing: antialiased;
    }

    body {
      background: radial-gradient(50% 50% at 65% 50%, rgba(36, 26, 76, 1) 0%, rgba(9, 3, 28, 1) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: var(--spacing-md);
    }

    a {
      color: inherit;
    }

    /* Utility Classes */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-glass);
    }

    .btn-primary {
      background: var(--primary-gradient) !important;
      border: 2px solid var(--glass-border) !important;
      border-radius: var(--border-radius-sm) !important;
      color: var(--text-primary) !important;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: "Monda", Helvetica !important;
      font-weight: 500;
      padding: var(--spacing-sm) var(--spacing-lg);
    }

    .btn-primary:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 25px rgba(127, 75, 231, 0.3) !important;
    }

    .btn-secondary {
      background: var(--glass-bg) !important;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border) !important;
      border-radius: var(--border-radius-sm) !important;
      color: var(--text-primary) !important;
      transition: all 0.3s ease;
      font-family: "Monda", Helvetica !important;
    }

    .btn-secondary:hover {
      background: var(--hover-color) !important;
      transform: translateY(-2px);
    }

    .btn-light {
      background: var(--glass-bg) !important;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border) !important;
      border-radius: var(--border-radius-sm) !important;
      color: var(--text-primary) !important;
      transition: all 0.3s ease;
    }

    .btn-light:hover {
      background: var(--hover-color) !important;
      color: var(--colorful) !important;
    }

    .wallet-button-container {
      display: flex;
      justify-content: center;
      margin-bottom: var(--spacing-md);
    }

    .github {
      display: flex;
      justify-content: center;
      margin-bottom: var(--spacing-lg);
    }

    .wallet-button {
      position: relative;
      z-index: 1;
      font-size: 16px;
      padding: var(--spacing-sm) var(--spacing-xl);
    }

    .key-container {
      margin-top: var(--spacing-md);
      display: flex;
      flex-direction: column; 
      align-items: center;  
      justify-content: center; 
    }

    .key-display {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-glass);
      word-wrap: break-word;
      max-width: 400px;
      margin-top: var(--spacing-md);
      color: var(--text-primary);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-glass);
      overflow: hidden;
    }

    .dialog-panel {
      border-right: 1px solid var(--glass-border);
      padding: var(--spacing-md);
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      height: 400px;
      overflow-y: auto;
    }

    .dialog-item {
      padding: var(--spacing-sm);
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      transition: all 0.3s ease;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
      border: 1px solid transparent;
    }

    .dialog-item:hover {
      background: var(--hover-color);
      color: var(--text-primary);
      border-color: var(--glass-border);
      transform: translateY(-1px);
    }

    .message-area {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      height: 400px;
      overflow: hidden;
      padding: var(--spacing-md);
      background: rgba(255, 255, 255, 0.01);
      border-radius: var(--border-radius-md);
    }

    #chatArea {
      flex-grow: 1;
      overflow-y: auto;
      padding: var(--spacing-sm) 0;
    }

    .current-dialog {
      font-size: 18px;
      font-weight: 600;
      padding: var(--spacing-sm);
      border-bottom: 2px solid var(--colorful);
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
      text-align: center;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: var(--border-radius-sm);
    }

    .chat-message {
      margin-bottom: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 18px;
      max-width: 60%;
      display: inline-block;
      word-wrap: break-word;
      position: relative;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }

    .chat-message:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(127, 75, 231, 0.2);
    }

    .chat-message.own-message {
      background: var(--my-message-bg);
      color: var(--text-primary);
      align-self: flex-end;
      border-radius: 18px 18px 4px 18px;
    }

    .chat-message.friend-message {
      background: var(--other-message-bg);
      color: var(--text-primary);
      align-self: flex-start;
      border-radius: 18px 18px 18px 4px;
    }

    .timestamp {
      font-size: 0.75em;
      color: var(--text-muted);
      margin-left: 3px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: var(--spacing-sm);
    }

    .input-area {
      display: flex;
      padding: var(--spacing-sm);
      background: var(--input-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      margin-top: auto;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--glass-border);
      gap: var(--spacing-xs);
    }

    .emoji-picker {
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
    }

    .form-control {
      background: var(--glass-bg) !important;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border) !important;
      border-radius: var(--border-radius-sm) !important;
      color: var(--text-primary) !important;
      transition: all 0.3s ease;
    }

    .form-control::placeholder {
      color: var(--text-muted) !important;
    }

    .form-control:focus {
      background: var(--glass-bg) !important;
      border-color: var(--colorful) !important;
      box-shadow: 0 0 0 2px rgba(239, 123, 227, 0.2) !important;
      color: var(--text-primary) !important;
    }

    .new-dialog-input {
      margin-bottom: var(--spacing-sm) !important;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--glass-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-gradient);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(162, 124, 238, 0.8);
    }

    /* Avatar styling */
    img[style*="border-radius:50%"] {
      border: 2px solid var(--glass-border);
      box-shadow: 0 2px 10px rgba(127, 75, 231, 0.2);
    }

    /* GitHub icon container */
    .icon-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }

    .icon-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(127, 75, 231, 0.3);
      background: var(--hover-color);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .chat-container {
        flex-direction: column;
        margin: var(--spacing-sm);
      }
      .dialog-panel {
        border-right: none;
        border-bottom: 1px solid var(--glass-border);
        height: auto;
        max-height: 300px;
      }
      .message-area {
        height: auto;
        max-height: 400px;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: var(--spacing-sm);
      }
    }

    @media (max-width: 480px) {
      body {
        padding: var(--spacing-xs);
      }
    }
  </style>
</head>

<body>

  <div class="wallet-button-container">
    <button class="btn btn-secondary wallet-button" id="walletButton">Connect Wallet</button>
  </div>
  <div class="github">
    <a href="https://github.com/xtzchads/chat.tez.cool" target="_blank" class="icon-link">
      <img src="https://stake.tez.cool/icons/Tezos-social-icon-black-04.png" id="githubIcon" style="height:24px;width:24px;filter: invert(100%);" alt="Tezos Icon">
    </a>
  </div>
  <!--<div class="key-container">
    <button class="btn btn-success" id="generateKeyButton">Generate Keypair</button>
    <div id="keyPairDisplay" class="key-display" style="display: none;">
      <h5>Public Key</h5>
      <pre id="publicKey"></pre>
      <h5>Private Key</h5>
      <pre id="privateKey"></pre>
      <button class="btn btn-secondary" id="copyPrivateKeyButton" data-bs-toggle="tooltip" title="Copy Private Key">Copy Private Key</button>
      <button class="btn btn-secondary" id="publish" data-bs-toggle="tooltip" title="Publish public key">Publish Public Key</button>
    </div>
  </div>-->
  <div class="chat-container">
    <div class="row flex-grow-1">
      <div class="col-12 col-md-4 dialog-panel">
        <input type="text" id="newDialogInput" class="form-control new-dialog-input"
          placeholder="Paste 36-character address to add dialog..." oninput="handleAddressInput(event)">
      </div>
      <div class="col-12 col-md-8 message-area">
        <div class="current-dialog" id="currentDialogTitle"></div>
        <div id="chatArea"></div>
        <div class="input-area">
          <button class="btn btn-light" id="emojiButton">
            <span class="emoji-picker">😊</span>
          </button>
          <input type="text" id="messageInput" class="form-control me-2" placeholder="Type your message...">
          <button class="btn btn-primary" id="sendButton">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { EmojiButton } from '/js/emoji.min.js';
    const emojiButton = document.getElementById('emojiButton');
    const picker = new EmojiButton();

    emojiButton.addEventListener('click', () => {
      picker.togglePicker(emojiButton);
    });

    picker.on('emoji', emoji => {
      messageInput.value += emoji.emoji;
    });
  </script>

  <script>
    /*async function generateKeypair() {
    const keyPair = await window.crypto.subtle.generateKey(
      {
        name: "RSA-OAEP",
        modulusLength: 2048,
        publicExponent: new Uint8Array([1, 0, 1]),
        hash: "SHA-256"
      },
      true,
      ["encrypt", "decrypt"]
    );
	
    const publicKey = await exportKey(keyPair.publicKey, "spki"); 
    const privateKey = await exportKey(keyPair.privateKey, "pkcs8"); 

    document.getElementById('publicKey').textContent = publicKey;
    document.getElementById('privateKey').textContent = privateKey;
    document.getElementById('keyPairDisplay').style.display = 'block';
  }

  async function exportKey(key, format) {
    const exportedKey = await window.crypto.subtle.exportKey(format, key);
    const binaryString = String.fromCharCode(...new Uint8Array(exportedKey));
    const base64Key = window.btoa(binaryString);

    if (format === "spki") {
      return `-----BEGIN PUBLIC KEY-----\n${base64Key}\n-----END PUBLIC KEY-----`;
    } else if (format === "pkcs8") {
      return `-----BEGIN PRIVATE KEY-----\n${base64Key}\n-----END PRIVATE KEY-----`;
    }
    return null;
  }
  document.getElementById('copyPrivateKeyButton').addEventListener('click', () => {
    const privateKeyText = document.getElementById('privateKey').textContent;
    navigator.clipboard.writeText(privateKeyText).then(() => {
      //alert('Private key copied to clipboard!');
    }).catch(err => {
      console.error('Failed to copy private key: ', err);
    });
  });

  document.getElementById('generateKeyButton').addEventListener('click', generateKeypair);
    */
    let client = new beacon.DAppClient({
      name: 'Chad Chat'
    });
    let permissions;
    let current = '';

    const chatArea = document.getElementById('chatArea');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const walletButton = document.getElementById('walletButton');

    sendButton.disabled = true;

    sendButton.addEventListener('click', sendMessage);

    function sendMessage() {
      const messageText = messageInput.value.trim();
      if (messageText && !sendButton.disabled) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message own-message';
        messageDiv.textContent = messageText;

        const messageContainer = document.createElement('div');
        messageContainer.style.display = 'flex';
        messageContainer.style.justifyContent = 'flex-end';
        messageContainer.appendChild(messageDiv);

        const timestampDiv = document.createElement('div');
        const timestamp = new Date(Date.now());
        timestampDiv.className = 'timestamp';
        timestampDiv.textContent = formatTimestamp(timestamp);
        messageContainer.appendChild(timestampDiv);

        chatArea.appendChild(messageContainer);

        messageInput.value = '';
        chatArea.scrollTop = chatArea.scrollHeight;
        send(hex(messageText), current);
      }
    }

    function hex(str) {
      return Array.from(new TextEncoder().encode(str))
        .map(byte => byte.toString(16).padStart(2, '0'))
        .join('');
    }

    async function disconnectWallet() {
      await client.clearActiveAccount();
      walletButton.textContent = 'Connect Wallet';
      permissions = null;
      document.querySelector('.dialog-panel').innerHTML = '';
      chatArea.innerHTML = '';
      clearSelectedDialog();
    }

    async function connectWallet() {
      try {
        if (!permissions?.address) {
          permissions = await client.requestPermissions();
          checkActiveSession();
        }
      } catch (error) {
        console.error('Error connecting wallet:', error);
        alert('Failed to connect wallet. Please try again.');
      }
    }

    walletButton.addEventListener('click', () => {
      if (permissions?.address) {
        disconnectWallet();
      } else {
        connectWallet();
      }
    });

    async function checkActiveSession() {
      const activeAccount = await client.getActiveAccount();
      if (activeAccount) {
        permissions = { address: activeAccount.address };
        walletButton.textContent = 'Disconnect Wallet';
        document.querySelector('.chat-container').style.display='flex';
        fetchTransactionHistory(permissions.address);
      } else {
        document.querySelector('.chat-container').style.display='none';
        walletButton.textContent = 'Connect Wallet';
        clearSelectedDialog();
      }
    }

    async function fetchTransactionHistory(address) {
      try {
        const [sentResponse, receivedResponse] = await Promise.all([
          fetch(`https://api.tzkt.io/v1/operations/transactions?sender=${address}&target=KT1NuwjJ2wwaRGCL2yR3WeUzdELNzejVBJz7&status=applied&limit=1000&sort.desc=id`),
          fetch(`https://api.tzkt.io/v1/operations/transactions?target=KT1NuwjJ2wwaRGCL2yR3WeUzdELNzejVBJz7&parameter.to_=${address}&status=applied&limit=1000&sort.desc=id`)
        ]);

        const sentTransactions = await sentResponse.json();
        const receivedTransactions = await receivedResponse.json();
        const combined = [...sentTransactions, ...receivedTransactions];
        const combinedTransactions = Array.from(new Map(combined.map(tx => [tx.id, tx])).values());
        combinedTransactions.sort((a, b) => a.id - b.id);

        const dialogPanel = document.querySelector('.dialog-panel');
        dialogPanel.innerHTML = '<input type="text" id="newDialogInput" class="form-control new-dialog-input" placeholder="Paste 36-character address to add dialog..." oninput="handleAddressInput(event)">';

        const uniqueAddresses = new Set();

        combinedTransactions.forEach(tx => {
          const senderAddress = tx.sender?.address;
          const receiverAddress = tx.parameter?.value?.to_;

          const friendAddress = (senderAddress === address) ? receiverAddress : senderAddress;

          if (!uniqueAddresses.has(friendAddress)) {
            uniqueAddresses.add(friendAddress);

            const dialogItem = document.createElement('div');
            dialogItem.className = 'dialog-item';
            dialogItem.textContent = friendAddress;
            dialogItem.addEventListener('click', () => loadChat(friendAddress, combinedTransactions, address));
            dialogPanel.appendChild(dialogItem);
          }
        });
        if (current != '') {
          loadChat(current, combinedTransactions, address);
        }
      } catch (error) {
        console.error('Error fetching transaction history:', error);
      }
    }

    function loadChat(friendAddress, transactions, currentAddress) {
      const chatArea = document.getElementById('chatArea');
      const currentDialogTitle = document.getElementById('currentDialogTitle');
      chatArea.innerHTML = '';
      currentDialogTitle.textContent = `Chat with ${friendAddress}`;
      current = friendAddress;

      sendButton.disabled = false;

      transactions
        .filter(tx => {
          const senderAddress = tx.sender?.address;
          const receiverAddress = tx.parameter?.value?.to_;

          return (
            (senderAddress === currentAddress && receiverAddress === friendAddress) ||
            (senderAddress === friendAddress && receiverAddress === currentAddress)
          );
        })
        .forEach(tx => {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'chat-message';

          const isOwnMessage = tx.sender?.address === currentAddress;
          messageDiv.textContent = hexToString(tx.parameter?.value?.metadata?.name);

          if (isOwnMessage) {
            messageDiv.classList.add('own-message');
          } else {
            messageDiv.classList.add('friend-message');
          }

          const messageContainer = document.createElement('div');
          messageContainer.style.display = 'flex';
          messageContainer.style.justifyContent = isOwnMessage ? 'flex-end' : 'flex-start';
          if (!isOwnMessage)
          messageContainer.innerHTML='<img style="width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:5px;" src="https://services.tzkt.io/v1/avatars/'+escapeHtml(friendAddress)+'"/>';
          messageContainer.appendChild(messageDiv);
          const timestampDiv = document.createElement('div');
          const timestamp = new Date(tx.timestamp);
          timestampDiv.className = 'timestamp';
          timestampDiv.textContent = formatTimestamp(timestamp);
          messageContainer.appendChild(timestampDiv);

          chatArea.appendChild(messageContainer);
        });

      chatArea.scrollTop = chatArea.scrollHeight;
    }
    function escapeHtml(input) {
    return input
        .replace(/&/g, '&amp;') 
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function formatTimestamp(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function clearSelectedDialog() {
      sendButton.disabled = true;
    }

    function addNewDialog(address) {
      const dialogPanel = document.querySelector('.dialog-panel');
      const dialogItem = document.createElement('div');
      dialogItem.className = 'dialog-item';
      dialogItem.textContent = address;
      dialogItem.addEventListener('click', () => loadChat(address, [], permissions.address));
      dialogPanel.appendChild(dialogItem);
    }

    client.subscribeToEvent(beacon.BeaconEvent.ACTIVE_ACCOUNT_SET, (account) => {
      checkActiveSession();
    });

    function hexToString(hex) {
      const bytes = [];
      for (let i = 0; i < hex.length; i += 2) {
        bytes.push(parseInt(hex.substr(i, 2), 16));
      }
      return new TextDecoder('utf-8').decode(new Uint8Array(bytes));
    }

    async function send(message, recipient) {
      try {
        if (!permissions?.address) {
          permissions = await client.requestPermissions();
        }
        const operation = [{
          amount: "0",
          kind: beacon.TezosOperationType.TRANSACTION,
          source: permissions.address,
          destination: "KT1NuwjJ2wwaRGCL2yR3WeUzdELNzejVBJz7",
          parameters: {
            entrypoint: "mint",
            value: {"prim":"Pair","args":[[{"prim":"Elt","args":[{"string":"artifactUri"},{"bytes":hex("https://services.tzkt.io/v1/avatars/"+permissions.address)}]},{"prim":"Elt","args":[{"string":"name"},{"bytes":message}]}],{"string":recipient}]}
          }
        }];

        const response = await client.requestOperation({
          operationDetails: operation
        });
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    function handleAddressInput(event) {
      const inputValue = event.target.value.trim();
      
      // Check if the input is exactly 36 characters long (typical Tezos address length)
      if (inputValue.length === 36) {
        // Basic validation: check if it starts with tz1, tz2, tz3, or KT1 (common Tezos address prefixes)
        if (inputValue.match(/^(tz1|tz2|tz3|KT1)[A-Za-z0-9]{33}$/)) {
          addNewDialog(inputValue);
          loadChat(inputValue, [], permissions.address);
          event.target.value = '';
        }
      }
    }

    function handleKeyDown(event) {
      // Keep the old functionality as fallback for Enter key
      console.log('Key pressed:', event.key);
      if (event.key === 'Enter') {
        event.preventDefault();
        const inputValue = event.target.value.trim();
        if (inputValue) {
          addNewDialog(inputValue);
          loadChat(inputValue, [], permissions.address)
          event.target.value = '';
        }
      }
    }

    setInterval(checkActiveSession, 60000);
  </script>
</body>

</html>
