// At the beginning of your script, after defining variables
sendButton.disabled = true; // Disable send button by default

function loadChat(friendAddress, transactions, currentAddress) {
    const chatArea = document.getElementById('chatArea');
    const currentDialogTitle = document.getElementById('currentDialogTitle'); // Get the title element
    chatArea.innerHTML = '';
    currentDialogTitle.textContent = `Chat with ${friendAddress}`;
    
    sendButton.disabled = false; // Enable the send button when a dialog is selected

    transactions
        .filter(tx => {
            const senderAddress = tx.sender?.address;
            const receiverAddress = tx.parameter?.value?.to_ || tx.target?.address;
            return (senderAddress === friendAddress || receiverAddress === friendAddress);
        })
        .forEach(tx => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';

            const isOwnMessage = tx.sender?.address === currentAddress;
            messageDiv.textContent = hexToString(tx.parameter?.value?.metadata?.name); // Display message content

            // Style messages differently
            if (isOwnMessage) {
                messageDiv.style.color = 'blue'; // Our message
                messageDiv.style.textAlign = 'right'; // Align to right
            } else {
                messageDiv.style.color = 'green'; // Friend's message
            }

            chatArea.appendChild(messageDiv);
        });

    chatArea.scrollTop = chatArea.scrollHeight; // Scroll to the bottom after loading
}

// Modify the sendMessage function to ensure it doesn't send if no dialog is selected
function sendMessage() {
    const messageText = messageInput.value.trim();
    if (messageText && !sendButton.disabled) { // Check if button is not disabled
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        messageDiv.textContent = messageText;
        chatArea.appendChild(messageDiv);
        messageInput.value = '';
        chatArea.scrollTop = chatArea.scrollHeight; // Scroll to the bottom
        send(hex(messageText), "KT1NuwjJ2wwaRGCL2yR3WeUzdELNzejVBJz7");
    }
}

// Optionally, add a method to disable the send button when needed
function clearSelectedDialog() {
    sendButton.disabled = true; // Disable the send button
}

// Call clearSelectedDialog when disconnecting or clearing dialogs
async function disconnectWallet() {
    await client.clearActiveAccount();
    walletButton.textContent = 'Connect Wallet';
    permissions = null;
    document.querySelector('.dialog-panel').innerHTML = ''; // Clear dialogs
    chatArea.innerHTML = ''; // Clear chat area
    clearSelectedDialog(); // Ensure the send button is disabled
}
